<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>T.A.G.</title>
    <link href="application.css" rel="stylesheet"/>
    <link href='http://fonts.googleapis.com/css?family=Nunito:400,700' rel='stylesheet' type='text/css'>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="ckeditor/ckeditor.js"></script>
  </head>
  <body>
    <header class="clearfix">
      <h1 class="tag">Thinking About Games</h1>
      <h1 class="ef">essay form</h1>
    </header>
    <ul id="errors" class="hidden"></ul>
    <form>
      <ul class="id-fields">
        <li class="id-field-section clearfix">
          <fieldset class="id-field">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required>
          </fieldset>
          <fieldset class="id-field">
            <label for="year">Year</label>
            <input type="text" id="year" name="year" required>
          </fieldset>
        </li>
        <li class="id-field-section clearfix">
          <fieldset class="id-field">
            <label for="semester">Semester</label>
            <fieldset class="radio-buttons clearfix">
              <input type="radio" name="semester" id="fall" value="Fall" required>
              <label class="fall" for="fall">Fall</label>
              <input type="radio" name="semester" id="spring" value="Spring" required>
              <label class="spring" for="spring">Spring</label>
            </fieldset>
          </fieldset>
          <fieldset class="id-field">
            <label for="_replyto">Your Email</label>
            <input type="email" id="email" name="_replyto" required>
          </fieldset>
        </li>
      </ul>
      <label for="essay">Essay</label>
      <textarea name="essay" id="essay-area"></textarea>
      <input type="hidden" id="subject" name="_subject"/>
      <input type="hidden" id="cc" name="_cc"/>
      <input type="text" name="_gotcha" style="display:none"/>
      <input type="hidden" id="next" name="_next"/>
      <input class="submit" type="submit" value="Submit">
    </form>
  </body>
</html>
<script>
  CKEDITOR.config.height = 500;
  CKEDITOR.config.removePlugins = 'autosave,save';
  CKEDITOR.replace('essay-area');

  if(!localStorage.getItem('essay')) {
    populateStorage();
  } else {
    loadEssay();
  }

  function populateStorage() {
    var editor = CKEDITOR.instances["essay-area"];
    localStorage.setItem('essay', editor.getData());
    loadEssay();
  }

  function setStyles() {
    var currentHTML = localStorage.getItem('essay');
    editor.setData(currentHTML);
  }

  CKEDITOR.instances["essay-area"].on('change', populateStorage);

  $("form").on("submit", function (event) {
    event.preventDefault();
    // get all data from the form
    var editor = CKEDITOR.instances["essay-area"];
    var essayHTML = editor.getData();
    // need to wrap html in a div to get the first level elements (in this case p's)
    var numParagraphs = $('<div>' + essayHTML + '</div>').find("p").length;
    var wordCount = editor.plugins.wordcount.wordCount;

    var name = $("#name").val();
    var year = $("#year").val();
    var email = $("#email").val();
    var semester = $('input[name=semester]:checked').val();
    // successful submission condition
    if (numParagraphs === 4 && wordCount === 300 && name && year && email &&
        typeof semester !== "undefined") {
      $("#subject").val(name + " [TAG][" + semester + " " + year + "]");
      $("#cc").val(email);
      $("#next").val(window.location.href + "success.html");
      $.ajax({
        url: "//formspree.io/fmw212@nyu.edu",
        method: 'POST',
        data: $(this).serialize(),
        dataType: 'json',
        beforeSend: function() {
          // alert("loading");
        },
        success: function(data) {
          localStorage.removeItem("essay");
        }
      });
    } else {
      // if the user submits with errors a second time before 7 seconds are up
      if (typeof window.timeoutID !== "undefined") {
        window.clearTimeout(timeoutID);
        $("#errors").empty();
      }
      // needed for IE 8 and 9
      if (!name || !year || !email || typeof semester === "undefined") {
        $("#errors").append("<li>Please fill in all fields.</li>");
      }
      if (wordCount !== 300) {
        $("#errors").append("<li>Please make sure your essay is exactly 300 words.</li>");
      }
      if (numParagraphs !== 4) {
        $("#errors").append("<li>Please include a title and exactly 3 paragraphs.</li>" +
                            "<li>(This will show up as 4 paragraphs in the editor)</li>");
      }
      // show errors
      $("#errors").removeClass("hidden");
      window.timeoutID = window.setTimeout(function () {
        $("#errors").addClass("hidden").empty();
      }, 7000);
    }
  });
</script>
